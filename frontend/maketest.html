<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Create Test</title>
		<link href="css/main.css" rel="stylesheet">
	</head>

	<body>
        <!-- NAVBAR -->
		<div class="color-main1">
	        <a href="instructor.html" class="color-main1 nav-bar">home</a>
	    </div>

        <!-- MAIN BODY-->
        <div class="main-container">
    		<div class="center">
    			<h1>Create a New Test</h1>
                <button type="button" class="button color-bold1" onclick="createTest()">Submit</button>
    		</div>

    		<div class="center">
    			<div class="container left-align">
                    <h4>Test Name</h4>
                    <div class="container color-main2 left-align">
                        <input class="input-test color-main1" id="testname" placeholder="Enter the name of this test">
                    </div>
                </div>
    		    
                <div class="container container-col-l">
                    <div class="container color-main2"> 
                        <h2 class="center">Available Questions</h2>
                        <div class="container">
                            [filter questions placeholder]
                            <select>Topic</select>
                            <button type="button" class="button color-bold1" onclick="applyFilter()">Apply</button>
                            <button type="button" class="button color-bold1" onclick="clearFilter()">Clear</button>
                        </div>
                        <table class="color-main2 left-align" id="qlist">
                            <tr>
                                <th>
                                    Question
                                </th>
                                <th></th>
                            </tr>   
                        </table> 
                    </div>
                </div>
                <div class="container container-col-r">
                    <div class="container color-main2"> 
                        <h2 class="center">Current Questions</h2>
                        <table class="color-main2 left-align" id="clist">
                            <tr>
                                <th>
                                    Question
                                </th>
                                <th>
                                    Value
                                </th>
                                <th>
                                    
                                </th>
                            </tr>   
                        </table> 
                    </div>
                </div>
    			
    		</div> 
        </div>
        <!-- END MAIN BODY -->

		<script>
            var currentTest = {
                "name" : null,
                "qids" : new Array()
            };
            var resp;

            function createTest(){
            	if(document.getElementById("testname").value.length == 0){
            		alert("Please enter a test name!");
            		return;
            	}

            	var checkedStr = "";
            	for(var i=0; i < currentTest.qids.length; i++){
            		checkedStr += currentTest.qids[i] + ',';
            	}
            	//stripping last comma
            	checkedStr = checkedStr.substring(0,checkedStr.length-1);
            	if(checkedStr.length == 0) {
            		alert("Select questions for test!");
            		return;
            	}

            	var jsonData = {
            		"testname" : document.getElementById("testname").value,
            		"qid" : checkedStr //selected questions from checkbox
            	}
            	var json = JSON.stringify(jsonData)

            	var xmlhttp = new XMLHttpRequest();
            	xmlhttp.onreadystatechange = function() {
            		if(this.readyState == 4) {
            			window.location.reload(false);
            		}
            	}

            	xmlhttp.open("POST", "https://web.njit.edu/~smc53/cs490/request-generic.php?request=AddTest&username=" + window.localStorage.getItem('username') + "&payload=" + json);
            	xmlhttp.send();
            }
			

			function removeTest(){
				var inputElements = document.getElementsByClassName('tfield');
                for(var i=0; inputElements[i]; ++i){
                    if(inputElements[i].checked){
                        var jsonData = {
                            "ID" : inputElements[i].value,
                        }
                        var json = JSON.stringify(jsonData);
                        console.log("REMOVE T json: " + json);

                        var xmlhttp = new XMLHttpRequest();
                        xmlhttp.onreadystatechange = function() {
                            if (this.readyState == 4) {
                                window.location.reload(false);
                            }
                        };
                        xmlhttp.open("POST", "https://web.njit.edu/~smc53/cs490/request-generic.php?request=RemoveTests&username=" + window.localStorage.getItem('username') +  "&payload=" + json);
            			xmlhttp.send();
                    }
                }
			}
			
			window.onload = function(){
				//Get all questions on load
				var xmlhttp = new XMLHttpRequest();
                xmlhttp.onreadystatechange = function() {
                	if(this.readyState == 4) {
                		if(this.responseText.indexOf('ERROR') !== -1){
                			alert("Error in GetQuestions response!");
                			return;
                		}

                		resp = JSON.parse(this.responseText);
                		if(resp.hasOwnProperty('questions')){
			                var list = document.getElementById("qlist");
			                for(var i = 0; i < resp.questions.length; i++){
			                	var qelement = JSON.parse(resp.questions[i]);

                                //check if current test contains this question ID
                                if(currentTest.qids.includes(qelement.ID)){
                                    continue;
                                }

                                var entry = document.createElement('tr');
                                entry.id = qelement.ID;
                                //question name
                                var qname = document.createElement('td');
                                qname.innerHTML = qelement.question;
                                entry.appendChild(qname);
                                //actions
                                var actions = document.createElement('td');
                                actions.className = "center";
                                //add
                                var btn_add = document.createElement('button');
                                btn_add.className = "button color-green  td-actions";
                                btn_add.onclick = (function(){
                                    var question_info = qelement;
                                    return function(){
                                        addQuestion(question_info);
                                    };
                                })();
                                btn_add.innerHTML = "Add";
                                actions.appendChild(btn_add);
                                entry.appendChild(actions);
                                list.appendChild(entry);
			                }
                		}
	                }
                };

	            xmlhttp.open("POST", "https://web.njit.edu/~smc53/cs490/request-generic.php?request=GetQuestions");
                xmlhttp.send();
            }


            function addQuestion(info){
                currentTest.qids.push(info.ID);
                console.log("current test: " + JSON.stringify(currentTest));

                //remove quesiton from available q's
                var qlist = document.getElementById("qlist");
                qlist.removeChild(document.getElementById(info.ID));

                //add question to curretn questions
                var clist = document.getElementById("clist");
                var row = document.createElement('tr');
                row.id = info.ID;
                //question name
                var rowname = document.createElement('td');
                rowname.innerHTML = info.question;
                row.appendChild(rowname);
                //point value of question
                var point = document.createElement('td');
                point.innerHTML = "10";
                point.className = "center";
                row.appendChild(point);
                //actions
                var btns = document.createElement('td');
                btns.className = "center";
                //add
                var btn_rm = document.createElement('button');
                btn_rm.className = "button color-red  td-actions";
                btn_rm.onclick = (function(){
                    var question_info = info;
                    return function(){
                        removeQuestion(question_info);
                    };
                })();
                btn_rm.innerHTML = "Remove";
                btns.appendChild(btn_rm);
                row.appendChild(btns);
                clist.appendChild(row);
            }


            function removeQuestion(info){
                console.log("remove info: " + info.ID);
                if(currentTest.qids.indexOf(info.ID) > -1){
                    console.log("test");
                    currentTest.qids.splice(currentTest.qids.indexOf(info.ID), 1);
                }
                console.log("current test: " + JSON.stringify(currentTest));

                //remove quesiton from available q's
                var clist = document.getElementById("clist");
                clist.removeChild(document.getElementById(info.ID));

                //add question to curretn questions
                var qlist = document.getElementById("qlist");
                var row = document.createElement('tr');
                row.id = info.ID;
                //question name
                var rowname = document.createElement('td');
                rowname.innerHTML = info.question;
                row.appendChild(rowname);
                //actions
                var btns = document.createElement('td');
                btns.className = "center";
                //add
                var btn_rm = document.createElement('button');
                btn_rm.className = "button color-green  td-actions";
                btn_rm.onclick = (function(){
                    var question_info = info;
                    return function(){
                        addQuestion(question_info);
                    };
                })();
                btn_rm.innerHTML = "Add";
                btns.appendChild(btn_rm);
                row.appendChild(btns);
                qlist.appendChild(row);
            }



		</script>
	</body>
</html>

