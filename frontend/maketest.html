<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Create Test</title>
		<link href="css/main.css" rel="stylesheet">
	</head>

	<body>
		<div class="color-main1">
	        <a href="instructor.html" class="color-main1 nav-bar">home</a>
	    </div>

		<div class="center">
			<h1>Create a New Test</h1>
		</div>

		<div class="center">
			<div class="container left-align"><h4>Test Name</h4></div>
		    <div class="container color-main2 left-align">
		    	<input class="input-test" id="testname" placeholder="Enter the name of this test">
		    </div>
		    
		    <div class="container left-align"><h4>Select Questions for test</h4></div>
		    <div class="container color-main2">	
			    <div class="color-main2 left-align" id="qlist"></div> 
			</div>

			<button type="button" class="button color-bold1" onclick="createTest()">Submit</button>
		
			<hr>

			<div class="center">
				<h2>Remove Test</h2>
			</div>
			<div class="container color-main2 left-align" id="tlist"></div>
			<button type="button" class="button color-bold1" onclick="removeTest()">Submit</button>

		</div> 

		<script>

            function createTest(){
            	if(document.getElementById("testname").value.length == 0){
            		alert("Please enter a test name!");
            		return;
            	}

            	var checkedStr = "";
            	var inputElements = document.getElementsByClassName('qfield');
            	for(var i=0; inputElements[i]; ++i){
            		if(inputElements[i].checked){
            			checkedStr += inputElements[i].value + ',';
            		}
            	}
            	//stripping last comma
            	checkedStr = checkedStr.substring(0,checkedStr.length-1);
            	if(checkedStr.length == 0) {
            		alert("Select questions for test!");
            		return;
            	}

            	var jsonData = {
            		"testname" : document.getElementById("testname").value,
            		"qid" : checkedStr //selected questions from checkbox
            	}
            	var json = JSON.stringify(jsonData)
            	console.log(json);

            	var xmlhttp = new XMLHttpRequest();
            	xmlhttp.onreadystatechange = function() {
            		if(this.readyState == 4) {
            			window.location.reload(false);
            		}
            	}

            	xmlhttp.open("POST", "https://web.njit.edu/~smc53/cs490/request-generic.php?request=AddTest&username=" + window.localStorage.getItem('username') + "&payload=" + json);
            	xmlhttp.send();
            }
			

			function removeTest(){
				var inputElements = document.getElementsByClassName('tfield');
                for(var i=0; inputElements[i]; ++i){
                    if(inputElements[i].checked){
                        var jsonData = {
                            "ID" : inputElements[i].value,
                        }
                        var json = JSON.stringify(jsonData);
                        console.log("REMOVE T json: " + json);

                        var xmlhttp = new XMLHttpRequest();
                        xmlhttp.onreadystatechange = function() {
                            if (this.readyState == 4) {
                                window.location.reload(false);
                            }
                        };
                        xmlhttp.open("POST", "https://web.njit.edu/~smc53/cs490/request-generic.php?request=RemoveTests&username=" + window.localStorage.getItem('username') +  "&payload=" + json);
            			xmlhttp.send();
                    }
                }
			}
			
			window.onload = function(){
				//Get all questions on load
				var xmlhttp = new XMLHttpRequest();
                xmlhttp.onreadystatechange = function() {
                	if(this.readyState == 4) {
                		console.log(this.responseText);
                		if(this.responseText.indexOf('ERROR') !== -1){
                			alert("Error in GetQuestions response!");
                			return;
                		}

                		resp = JSON.parse(this.responseText);
                		if(resp.hasOwnProperty('questions')){
			                var list = document.getElementById("qlist");
			                for(var i = 0; i < resp.questions.length; i++){
			                	var qelement = JSON.parse(resp.questions[i]);
			                    var entry = document.createElement('input');
			                    entry.className = 'qfield';
			                    entry.value = qelement.ID;
			                    entry.type = 'checkbox'
			                    list.appendChild(entry);
			                    list.appendChild(document.createTextNode(qelement.question));
			                    list.appendChild(document.createElement('br'));
			                }
                		}
	                }
                };

	            xmlhttp.open("POST", "https://web.njit.edu/~smc53/cs490/request-generic.php?request=GetQuestions");
                xmlhttp.send();

                //Get all Tests on load
                var xmlhttpTests = new XMLHttpRequest();
                xmlhttpTests.onreadystatechange = function() {
                	if(this.readyState == 4) {
                		console.log(this.responseText);
                		if(this.responseText.indexOf('ERROR') !== -1){
                			alert("Error in GetAllTests response!");
                			return;
                		}

                		resp = JSON.parse(this.responseText);
                		if(resp.hasOwnProperty('tests')){
			                var list = document.getElementById("tlist");
			                for(var i = 0; i < resp.tests.length; i++){
			                	var telement = JSON.parse(resp.tests[i]);
			                    var entry = document.createElement('input');
			                    entry.className = 'tfield';
			                    entry.value = telement.ID;
			                    entry.type = 'checkbox'
			                    list.appendChild(entry);
			                    list.appendChild(document.createTextNode(telement.name));
			                    list.appendChild(document.createElement('br'));
			                }
                		}
	                }
                };

	            xmlhttpTests.open("POST", "https://web.njit.edu/~smc53/cs490/request-generic.php?request=GetAllTests");
                xmlhttpTests.send();
			}	

		</script>
	</body>
</html>

