<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Instructor | View Grades</title>
		<link href="css/main.css" rel="stylesheet">
	</head>

	<body>
		<!-- NAVBAR -->
        <div class="color-main1">
            <a href="instructor.html" class="color-main1 nav-bar">home</a>
        </div>
	    <!-- MAIN BODY -->
		<div class="main-container" id="main">
            <div class="center">
                <h1 id="examname"></h1><hr>
            </div>
		</div>
		<!-- END MAIN BODY -->

		<script type="text/javascript">

            window.onload = function(){
                var xmlhttp = new XMLHttpRequest();
                //response from middle
                xmlhttp.onreadystatechange = function() {
                    if (this.readyState == 4) {
                        if(this.responseText.indexOf('ERROR') !== -1){
                            alert("Error in GetAllTests response!");
                            return;
                        }
                        var json = JSON.parse(this.responseText);
                        console.log(json);

                        var container = document.getElementById('main');
                        for(var i=0;i<json.grades.length;i++){
                            console.log(json.grades[i])
                            var stud_div = document.createElement('div');
                            stud_div.className = "container color-main2";
                            stud_div.innerHTML = "Student: " + json.grades[i].studentName;
                            container.appendChild(stud_div);

                            for(var j=0; j<json.grades[i].questions.length; j++){
                                var qdiv = document.createElement('div');
                                qdiv.className = "container color-main1";

                                //question text
                                var q_div = document.createElement('div');
                                var q_div_id = i+json.grades[i].questions[j].qid
                                q_div.id = q_div_id;
                                qdiv.appendChild(q_div);

                                var xmlhttp_question = new XMLHttpRequest();
                                xmlhttp_question.onreadystatechange = function() {
                                    var xml_qid = q_div_id;
                                    console.log("xml " + q_div_id + " " + xml_qid);
                                    if (this.readyState == 4) {
                                        if(this.responseText.indexOf('ERROR') !== -1){
                                            alert("Error in GetQuestion response!");
                                            return;
                                        }

                                        //fill test info for question 1
                                        var question_json = JSON.parse(this.responseText);
                                        console.log("xml2 " + JSON.stringify(question_json));
                                        if(question_json.hasOwnProperty("question")){
                                            document.getElementById(q_div_id).innerHTML = question_json.question;
                                        }
                                    }
                                };
                                var qdata = {
                                    "ID" : json.grades[i].questions[j].qid
                                };
                                xmlhttp_question.open("POST", "https://web.njit.edu/~smc53/cs490/request-generic.php?request=GetQuestion&username=" + window.localStorage.getItem('username') + "&payload=" + JSON.stringify(qdata));
                                xmlhttp_question.send();

                                qdiv.appendChild(document.createElement('hr'));
                                qdiv.appendChild(document.createTextNode("Score: "));
                                var score_div = document.createElement('textarea');
                                score_div.rows = 1;
                                score_div.cols = 5;
                                score_div.style = "resize:none;";
                                score_div.className = "center";
                                score_div.value = json.grades[i].questions[j].score;
                                qdiv.appendChild(score_div);
                                qdiv.appendChild(document.createTextNode(" / " + json.grades[i].questions[j].maxScore));
                                qdiv.appendChild(document.createElement('hr'));
                                if(json.grades[i].questions[j].answer !== null){
                                    qdiv.appendChild(document.createTextNode(json.grades[i].questions[j].answer));
                                }else{
                                    qdiv.appendChild(document.createTextNode("NONE"));
                                }
                                
                                qdiv.appendChild(document.createElement('hr'));
                                var comment_div = document.createElement('textarea');
                                if(json.grades[i].questions[j].comments !== null){
                                    comment_div.value = json.grades[i].questions[j].comments.replace(/<br>/g, '\n');
                                }else{
                                    comment_div.value = "none";
                                }

                                comment_div.rows = 10;
                                comment_div.style = "resize:none; width:100%;";
                                qdiv.appendChild(comment_div);
                                qdiv.appendChild(document.createElement('hr'));
                                var edit_btn = document.createElement('button');
                                edit_btn.className = "color-bold1 button";
                                edit_btn.innerHTML = "Edit";
                                var studentID = json.grades[i].studentID;
                                var examID = window.location.search.substring(1).split("=")[1];
                                var released = json.grades[i].released;
                                edit_btn.onclick = function(){
                                    console.log("edit question");

                                    var score = score_div;
                                    var comment = comment_div;
                                    

                                    //return function(){
                                        var xmlhttp2 = new XMLHttpRequest();
                                        xmlhttp2.onreadystatechange = function() {
                                            if (this.readyState == 4) {

                                            }
                                        }
                                        var payload = {
                                            "scores" : [score_div.value],
                                            "comments" : [comment_div.value.replace(/\n/g, '<br>')],
                                            "studentID" : studentID,
                                            "examID" : examID,
                                            "released" : released
                                        };
                                        console.log("EDITS " + JSON.stringify(payload));
                                        xmlhttp2.open("POST", "https://web.njit.edu/~smc53/cs490/request-generic.php?request=EditGradesForExam&username=" + window.localStorage.getItem('username')+ "&payload=" + JSON.stringify(payload));
                                        xmlhttp2.send();
                                    //};
                                }
                                qdiv.appendChild(edit_btn);
                                stud_div.appendChild(qdiv);
                            }
                            
                           
                        }
                        //fill username
                        document.getElementById('examname').appendChild(document.createTextNode('Test Grades : ' + json.grades[0].examName));
                        
                    }
                };
                var payload = {
                    "examID" : window.location.search.substring(1).split("=")[1]
                }
                xmlhttp.open("POST", "https://web.njit.edu/~smc53/cs490/request-generic.php?request=GetGradesForExam&username="+ window.localStorage.getItem('username')+ "&payload=" + JSON.stringify(payload));
                xmlhttp.send();
            }
		</script>
	</body>
</html>

